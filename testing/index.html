<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-10-19
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20151019" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Commons Testing &#x2013; Commons Testing</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/Weltraumschaf/commons">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="../index.html" id="bannerLeft" title="Weltraumschaf's Commons Java Library">
                <h2>Weltraumschaf's Commons Java Library</h2>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-10-19</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 2.1.0</li>
                          <li class="divider">|</li>             <li class="">
                    <a href="http://www.weltraumschaf.de" class="externalLink" title="Weltraumschaf">
        Weltraumschaf</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../" title="Weltraumschaf's Commons Java Library">
        Weltraumschaf's Commons Java Library</a>
        </li>
      <li class="divider ">/</li>
                <li class="">
                    <a href="./" title="Commons Testing">
        Commons Testing</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Commons Testing</li>
                
                
                    
      
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Commons</li>
                                
      <li>
    
                          <a href="../index.html" title="Home">
          <i class="none"></i>
        Home</a>
            </li>
                  
      <li>
    
                          <a href="../history.html" title="History">
          <i class="none"></i>
        History</a>
            </li>
                  
      <li>
    
                          <a href="../versions.html" title="Versions">
          <i class="none"></i>
        Versions</a>
            </li>
                                        <li class="nav-header">Reports</li>
                                                                                                                                
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-down"></i>
        Project Information</a>
                    <ul class="nav nav-list">
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>About</a>
          </li>
                      
      <li>
    
                          <a href="dependencies.html" title="Dependencies">
          <i class="none"></i>
        Dependencies</a>
            </li>
                      
      <li>
    
                          <a href="dependency-convergence.html" title="Dependency Convergence">
          <i class="none"></i>
        Dependency Convergence</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Commons Testing</h1>
<p>This module contains utilities and helpers for unit testing.</p>
<div class="section">
<h2><a name="General_Helpers"></a>General Helpers</h2>
<div class="section">
<h3><a name="CapturingPrintStream"></a>CapturingPrintStream</h3>
<p><tt>CapturingPrintStream</tt> is a class for capturing print stream which may be used to capture the output printed to <tt>System.out</tt> or <tt>System.err</tt>.</p>

<div class="source">
<div class="source">
<pre>final CapturingPrintStream out = new CapturingPrintStream();
System.setOut(out);
System.out.print(&quot;hello, world&quot;);
final String output = out.getCapturedOutput();
</pre></div></div>
<p>Same way you can redirect the error output by setting <tt>System.setErr(PrintStream)</tt>. Usually this is helpful if you have legacy code which uses <tt>System.out</tt> or <tt>System.err</tt> directly without any abstraction. You can capture that output and inspect it.</p>
<p>So essentially <tt>CapturingPrintStream</tt> is a convenient shorthand for:</p>

<div class="source">
<div class="source">
<pre>final ByteArrayOutputStream out = new ByteArrayOutputStream();
System.setOut(new PrintStream(out));
final String content = out.toString();
</pre></div></div></div>
<div class="section">
<h3><a name="DelayedRepeater"></a>DelayedRepeater</h3>
<p><tt>DelayedRepeater</tt> is a utility class to wait repeatedly for something until it happens. The use case are subject under test which does something asynchronous over the network or in other threads, but does not provide a callback API to hook in. Usually you fire your acting call and then loop with a <tt>Thread#sleep(int)</tt> until you can assert. But to do this all over the time by hand is tedious and error prone. Also you have untested logic in your test code. <tt>DelayedRepeater</tt> abstracts this &#x201c;sleeping loop&#x201d; away for you and is tested.</p>
<p>The basic idea is: You make your arrangement and acting of your test code as usual, but the assertion as a callback of the <tt>DelayedRepeater</tt>. You can give the factory method two parameters: 1. the time in milliseconds to wait until the callback is executed, 2. the number of tries. If you create one for example like <tt>DelayedRepeater.create(500, 3)</tt> then it will wait 500 ms before invoking the give callback the first time. The sequence is like:</p>

<div class="source">
<div class="source">
<pre> [ execute(...) ]
        |
        v
  [ wait 500 ms ]
        |
        v
[ 1st run()/call() ]
        |
        v
  [ wait 500 ms ]
        |
        v
[ 2nd run()/call() ]
        |
        v
  [ wait 500 ms ]
        |
        v
[ 3rd run()/call() ]
        |
        o
</pre></div></div>
<p>Example with <tt>Runnable</tt> as callback:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {
    
    @Test
    public void testSomeThing() {
        final SomeClass subjectUnderTest = new SomeClass();
        
        subjectUnderTest.doSomethingLongAsync();
        
        DelayedRepeater.create(500, 3).execute(new Runnable() {
            public void run() {
                assertThat(
                    subjectUnderTest.getResult(),
                    is(&quot;foobar&quot;));
            }
        });
    }
    
}
</pre></div></div>
<p>Example with <tt>Callable</tt> as callback:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {
    @Test
    public void testSomeThing() {
        final SomeClass subjectUnderTest = new SomeClass();
        
        subjectUnderTest.doSomethingLongAsync();
        
        DelayedRepeater.create(500, 3).execute(new Callable&lt;Void&gt;() {
            public Void call() throws Exception {
                assertThat(
                    subjectUnderTest.getResult(),
                    is(&quot;foobar&quot;));
                return null;
            }
        });
    }
}
</pre></div></div></div></div>
<div class="section">
<h2><a name="JUnit_Rules"></a>JUnit Rules</h2>
<p>This module provides custom rules for <a class="externalLink" href="http://junit.org/">JUnit</a>. For more information about JUnit rules see <a class="externalLink" href="https://github.com/junit-team/junit/wiki/Rules">the documentation</a>.</p>
<div class="section">
<h3><a name="CapturedOutput_Rule"></a>CapturedOutput Rule</h3>
<p>This rule utilizes the <tt>CapturingPrintStream</tt> to redirect <tt>System.out</tt> and <tt>System.err</tt> before each test method invocation and restores them afterwards to the origins. The rule also provides methods to set expectation matchers for the captured string. </p>

<div class="source">
<div class="source">
<pre>public class TestSomething {

    @Rule
    public final CapturedOutput output = new CapturedOutput();

    @Test
    public void captureOut() {
        output.expectOut(&quot;foobar&quot;);
        output.expectOut(not(&quot;snafu&quot;));

        System.out.print(&quot;foobar&quot;);
    }

    @Test
    public void captureErr() {
        output.expectErr(&quot;foobar&quot;);
        output.expectErr(not(&quot;snafu&quot;));

        System.err.print(&quot;foobar&quot;);
    }
}
</pre></div></div></div>
<div class="section">
<h3><a name="JavaDefaultLocale_Rule"></a>JavaDefaultLocale Rule</h3>
<p>Sometime you have legacy code which relies internally on the java default locale and you can&#x2019;t inject or change this from your test code. This is a big pain if you have machines with different locales (e.g. de_DE as developer machine and en_US as CI machine). A common approach is to set the default locale before the tests to a fix one. But you have to remember to set it back to not influence other code which may rely on that locale:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {

    private Locale backup;
    
    @Before
    public void setLocale() {
        backup = Locale.getDefault();
        Locale.setDefault(Locale.ENGLISH);
    }
    
    @After
    public void restoreLocale9) {
        Locale.setDefault(backup);    
    }

    @Test
    public void testSomeThing() {
        ...
    }
}
</pre></div></div>
<p>But this approach is tedious and error prone. It is easy to forget resetting. Also it is code duplication and violates DRY if you do this in all your tests. The <tt>JavaDefaultLocale</tt> is for doing this tedious stuff for you:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {

    @Rule 
    public final JavaDefaultLocale localeRule = new JavaDefaultLocale(Locale.ENGLISH);
    
    @Test
    public void testSomeThing() {
        ...
    }
}
</pre></div></div></div>
<div class="section">
<h3><a name="Repeater_Rule"></a>Repeater Rule</h3>
<p>The repeater rule executes annotated tests multiple times.</p>
<div class="section">
<h4><a name="RunTimes_Annotation"></a>RunTimes Annotation</h4>
<p>Sometimes you have legacy code with weird timing issues or other side effects and the code only does sometimes something wrong. Imagine: The customer says every one hundred X or so the bug happens. But when you runt your tests every thing is fine. Then you start hitting the run test button over and over and BANG!, the bug occurs. But the next time it is gone. Then you start to write loops in your test code to provoke the bug. But this is not good practice to add logic into your tests. (Because where are tests for this logic?)</p>
<p>The repeat rule is a tested helper to do that. You add that rule and annotate the tests you wanted repeatedly executed with an annotation:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {

    @Rule 
    public final Repeater repeater = new Repeater();
    
    @Test
    @RunTimes(100)
    public void testSomeThing() {
        ...
    }
}
</pre></div></div></div>
<div class="section">
<h4><a name="RunMaxTimes_Annotation"></a>RunMaxTimes Annotation</h4>
<p>Common pain in the ass are UI tests. You have tests which runs fine on your machine and they run fine on the CI almost always, but sometimes they fail. Then you investigate, but they rune fine on your machine and on the CI. But sometimes&#x2026; The problem is timing: You have to define timeouts in your UI test framework. That&#x2019;s almost always enough. But in rare situation (heavy load, solar wind, what ever) the timeout is not enough and the tests fail randomly without a reason. This erodes the whole test suite because everybody starts to ignore the red CI.</p>
<p>A simple solution is: If a single UI test fails, then start it again and see if fails again. Unless everything is fine. If it continues failing then there is maybe a real bug. But you don&#x2019;t want to do this manually with the whole suite. For this use case is the <tt>RunMaxtimes</tt> annotation. In contrast to the <tt>RunTimes</tt> annotation it does not run the test the given value times, it only runs the test multiple times if it fails until it succeeds or the max times value is reached. If one of the runs succeeded the test is marked green. If all runs failed the test is marked red.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>public class TestSomething {

    @Rule 
    public final Repeater repeater = new Repeater();
    
    @Test
    @RunMaxTimes(3)
    public void testSomeThing() {
        ...
    }
}
</pre></div></div>
<p>In the example above the test is executed one time. If it didn&#x2019;t failed that&#x2019;s it. Unless the test is repeated and executed second time. If it didn&#x2019;t failed that&#x2019;s it. Unless the test is repeated again and executed third and last time. If it failed again, then the test is marked red. So the test is always executed multiple times until it succeeded or the given number of tries is exhausted.</p></div></div></div>
<div class="section">
<h2><a name="Custom_Hamcrest_Matchers"></a>Custom Hamcrest Matchers</h2>
<p>This module provides custom matchers for <a class="externalLink" href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a>. All of them are provided by the <tt>CommonsTestingMatchers</tt> factory.</p>
<div class="section">
<h3><a name="ApplicationExceptionCodeMatcher"></a>ApplicationExceptionCodeMatcher</h3>
<p>This matcher helps you to match your own exit code implementations (see application module).</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>enum ExitCodeImpl implements ExitCode {
    FOO(0), BAR(1), BAZ(2);

    private final int code;

    private ExitCodeImpl(final int code) {
        this.code = code;
    }

    @Override
    public int getCode() {
        return code;
    }
}

public class MyTest {

    @Test
    public void testForExitCodeEnum() {
        final ApplicationException ex =
            new ApplicationException(ExitCodeImpl.FOO, &quot;foo&quot;);

        assertThat(ex, hasExitCode(ExitCodeImpl.FOO));
    }
    
    @Test
    public void testForExitCodeEnum() {
        final ApplicationException ex =
            new ApplicationException(ExitCodeImpl.FOO, &quot;foo&quot;);

        assertThat(ex, hasExitCode(0));
    }
}
</pre></div></div></div>
<div class="section">
<h3><a name="HasMessage"></a>HasMessage</h3>
<p>This matcher helps you to match the message of any <tt>Throwable</tt>.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>public class MyTest {

    private final SomeClass sut = new SomeClass();
    
    @Test
    public void throwsFooException() {
        final Throwable result = sut.makeError(&quot;foobar&quot;);
        
        assertThat(result, hasMessage(is(&quot;foobar&quot;)));
    }
}
</pre></div></div></div>
<div class="section">
<h3><a name="IsCloseTo_Matcher_for_IntegerLong"></a>IsCloseTo Matcher for Integer/Long</h3>
<p>It is common sense that floating point numbers must not be compared directly, but with a delta. <a class="externalLink" href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a> provides an <tt>IsCloseTo</tt> matcher for doubles.</p>
<p>Sometimes there is a rare case you want to match an integer number with a delta. With <tt>LongIsCloseTo</tt> and <tt>IntegerIsCloseTo</tt> you can do that.</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2015
                        <a href="http://www.weltraumschaf.de">Weltraumschaf</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
